# Shallow Flow Matching
Official implementation of the paper: Shallow Flow Matching for Coarse-to-Fine Text-to-Speech Synthesis \
(updating) \
<a href='https://arxiv.org/abs/2505.12226'><img src='https://img.shields.io/badge/arXiv-red'></a>
<a href='https://ydqmkkx.github.io/SFMDemo/'><img src='https://img.shields.io/badge/Demo-blue'></a>

## Environment
1. We use python=3.10.
2. A simple way for building the environment of Matcha-TTS-sfm, StableTTS-sfm, and CosyVoice-DiT-sfm:
- For Matcha-TTS
```bash
pip install matcha-tts
pip uninstall matcha-tts
pip install transformers vocos torchdiffeq matplotlib==3.9.3
```
- For StableTTS (only support English) and CosyVoice-DiT-sfm, please continue
```bash
pip install eng_to_ipa 
```
- For CosyVoice-sfm, not the above but the official guidance is needed. Please check the README.md in its folder,
3. We use the [Open MPI](https://docs.open-mpi.org) for multi-node training.
4. Please continue to read the README.md in each model's folder.

## Modifications and implementations
1. We use the ODE solvers from `torchdiffeq` in this open-source version to make it easy to try different solvers.
- For fixed-step solvers, the number of steps is predefined by `n_timesteps`. 
- For adaptive-step solvers, the number of steps is dynamically determined by `rtol` and `atol` in the flow modules, which are defaultly set to 1e-5, the same with the settings in StableTTS. `n_timesteps` just determines the size of output trajectory.
2. Directory and file paths are replaced with placeholders (`xxx`).
3. We have reorganized and simplified the code, and optimized variable notation. If you encounter any problems, please open an issue.
4. In the code, the `sigma` except `sigma_min` is the variance (σ²) but not the std (σ).
5. For the DDP training of CosyVoice, we have changed the code for training to solve several problems.

## Cross-sentence evaluation
We offer the necessary files of cross-sentence evaluations in `libritts-cross_sentence-infer`.
- For each line of `.txt`, the left is the prompt filename and the right is the target filename.
- The tokens of `.pt` are generated by the LLM module of CosyVoice.

## Citation
```bibtex
@article{sfm,
 author    = {Dong Yang and Yiyi Cai and Yuki Saito and Lixu Wang and Hiroshi Saruwatari},
 title     = {Shallow Flow Matching for Coarse-to-Fine Text-to-Speech Synthesis},
 year      = {2025},
 journal   = {arXiv preprint arXiv:2505.12226},
}

@inproceedings{matcha-tts,
 author    = {Shivam Mehta and Ruibo Tu and Jonas Beskow and {\'{E}}va Sz{\'{e}}kely and Gustav Eje Henter},
 title     = {{Matcha-TTS}: {A} Fast {TTS} Architecture with Conditional Flow Matching},
 year      = {2024},
 pages     = {11341--11345},
 booktitle = {{IEEE} International Conference on Acoustics, Speech and Signal Processing (ICASSP)},
}

@misc{stableTTS,
 author    = {},
 title     = {{StableTTS}},
 year      = {2024},
 howpublished = {\url{https://github.com/KdaiP/StableTTS}}
}

@article{cosyvoice,
 author    = {Zhihao Du and Qian Chen and Shiliang Zhang and Kai Hu and Heng Lu and Yexin Yang and Hangrui Hu and Siqi Zheng and Yue Gu and Ziyang Ma and Zhifu Gao and Zhijie Yan},
 title     = {{CosyVoice}: {A} Scalable Multilingual Zero-shot Text-to-speech Synthesizer based on Supervised Semantic Tokens},
 year      = {2024},
 journal   = {arXiv preprint arXiv:2407.05407},
}
```